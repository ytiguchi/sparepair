rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /reports/{reportId} {
      // 読み取りは誰でも可能（社内ツールとして使用）
      allow read: if true;
      
      // 作成時のバリデーション
      allow create: if request.resource.data.keys().hasAll(['facility', 'location', 'item', 'status', 'timestamp'])
                    && request.resource.data.facility is string
                    && request.resource.data.location is string
                    && request.resource.data.item is string
                    && request.resource.data.status in ['Open', 'In Progress', 'Fixed']
                    && request.resource.data.facility.size() > 0
                    && request.resource.data.location.size() > 0
                    && request.resource.data.location.size() <= 200
                    && request.resource.data.item.size() > 0
                    && request.resource.data.item.size() <= 200
                    && (!request.resource.data.keys().hasAny(['remarks']) || request.resource.data.remarks.size() <= 2000)
                    && (!request.resource.data.keys().hasAny(['reporter']) || request.resource.data.reporter.size() <= 100)
                    && (!request.resource.data.keys().hasAny(['imageUrl']) || request.resource.data.imageUrl.size() <= 2000000);
      
      // 更新時のバリデーション
      allow update: if request.resource.data.keys().hasAll(['facility', 'location', 'item', 'status'])
                    && request.resource.data.facility is string
                    && request.resource.data.location is string
                    && request.resource.data.item is string
                    && request.resource.data.status in ['Open', 'In Progress', 'Fixed']
                    && request.resource.data.location.size() <= 200
                    && request.resource.data.item.size() <= 200
                    && (!request.resource.data.keys().hasAny(['remarks']) || request.resource.data.remarks.size() <= 2000);
      
      // 削除は許可
      allow delete: if true;
    }
  }
}
